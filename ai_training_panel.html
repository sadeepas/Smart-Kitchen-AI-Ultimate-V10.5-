<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Training Studio | Kitchen AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen p-4 md:p-8 selection:bg-purple-500 selection:text-white">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
        <div class="flex items-center gap-4">
            <div
                class="w-14 h-14 bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-900/40">
                <i class="fa-solid fa-brain text-2xl text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">AI Training Center</h1>
                <p class="text-slate-500 text-sm">Teach your Kitchen Assistant new tricks.</p>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="document.getElementById('import-file').click()"
                class="px-5 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium transition flex items-center gap-2 border border-slate-600">
                <i class="fa-solid fa-upload"></i> Import
            </button>
            <input type="file" id="import-file" class="hidden" accept=".json,.csv" onchange="handleImport(this)">
            <button onclick="exportKnowledge()"
                class="px-5 py-2.5 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold transition flex items-center gap-2 shadow-lg shadow-purple-900/40">
                <i class="fa-solid fa-download"></i> Export DB
            </button>
            <button onclick="window.location.href='ai_training_legacy.html'"
                class="px-5 py-2.5 rounded-xl bg-orange-900/20 hover:bg-orange-900/30 text-orange-400 font-medium transition flex items-center gap-2 border border-orange-700/30">
                <i class="fa-solid fa-clock-rotate-left"></i> Legacy Mode
            </button>
            <button onclick="window.location.href='index.html'"
                class="px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium transition flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> Back to App
            </button>
            <button onclick="window.location.href='admin_settings.html'"
                class="px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium transition flex items-center gap-2">
                <i class="fa-solid fa-gear"></i> Settings
            </button>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Knowledge Management -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Quick Add Card -->
            <div class="glass rounded-3xl p-6 border border-slate-800 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle text-purple-400"></i> New Knowledge
                    </h2>
                    <span class="text-xs font-mono text-slate-500 bg-slate-900 px-2 py-1 rounded">Single Entry
                        Mode</span>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">Trigger (User
                            says)</label>
                        <input id="new-q" type="text" placeholder="e.g. Who created you?"
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition placeholder-slate-600">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">Response (AI
                            replies)</label>
                        <input id="new-a" type="text" placeholder="e.g. I was built by Sadeepa."
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition placeholder-slate-600">
                    </div>
                </div>

                <button onclick="addKnowledge()"
                    class="mt-6 w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-purple-900/30 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Teach AI
                </button>
            </div>

            <!-- Knowledge Base List -->
            <div class="glass rounded-3xl p-6 border border-slate-800 shadow-xl min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-database text-blue-400"></i> Neural Database
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('file-upload').click()"
                            class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg transition border border-slate-700">
                            <i class="fa-solid fa-upload mr-1"></i> Import
                        </button>
                        <input type="file" id="file-upload" accept=".json,.csv" class="hidden"
                            onchange="handleImport(this)">

                        <button onclick="exportKnowledge()"
                            class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg transition border border-slate-700">
                            <i class="fa-solid fa-download mr-1"></i> Export
                        </button>

                        <button id="broadcast-btn" onclick="forceSync()"
                            class="text-xs bg-green-600/20 hover:bg-green-600/30 text-green-400 px-3 py-2 rounded-lg transition border border-green-600/30 flex items-center gap-2">
                            <i class="fa-solid fa-rotate"></i> Sync App
                        </button>
                    </div>
                </div>

                <div id="knowledge-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Dynamic Items -->
                </div>
            </div>

        </div>

        <!-- Right Column: Testing & Stats -->
        <div class="space-y-6">

            <!-- AI Test Bench -->
            <div
                class="bg-gradient-to-b from-slate-900 to-black rounded-3xl p-6 border border-slate-800 shadow-xl relative overflow-hidden group">
                <div
                    class="absolute -top-10 -right-10 w-32 h-32 bg-purple-600/20 rounded-full blur-3xl group-hover:bg-purple-600/30 transition duration-1000">
                </div>

                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2 relative z-10">
                    <i class="fa-solid fa-robot text-pink-500"></i> Test Simulator
                </h2>

                <div class="relative z-10">
                    <input id="test-q" type="text" placeholder="Type a message..."
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-sm text-white mb-3 focus:border-pink-500 outline-none">

                    <div id="test-result"
                        class="bg-black/40 rounded-xl p-4 min-h-[80px] text-sm text-slate-400 border border-slate-800/50 mb-3 font-mono">
                        <span class="opacity-50">AI response will appear here...</span>
                    </div>

                    <button onclick="testNeural()"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl border border-slate-700 transition text-sm">
                        Simulate Response
                    </button>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-white mb-1" id="stat-total">0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider font-bold">Total Rules</div>
                </div>
                <div class="glass-card rounded-2xl p-5 text-center">
                    <div class="text-3xl font-bold text-red-400 mb-1" id="stat-missed">0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider font-bold">Failed Queries</div>
                </div>
            </div>

            <!-- Missed Queries Log -->
            <div class="glass rounded-3xl p-6 border border-slate-800 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wide">Recent Failures</h2>
                    <button onclick="clearLogs()"
                        class="text-[10px] text-red-500 hover:text-red-400 hover:underline">Clear History</button>
                </div>

                <div id="logs-container" class="space-y-2 h-[200px] overflow-y-auto pr-1">
                    <!-- Logs -->
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- CORE LOGIC ---
        const DB_KEY = 'sk_app_ultimate_v7'; // Matching main app key (or kitchen_db_v7 if updated)
        // Note: script.js uses 'kitchen_db_v7' for its internal db, but saves entire DB to 'sk_app_ultimate_v7' or 'sk_app_ultimate_v6'.
        // Let's check script.js save() method. It says: localStorage.setItem('sk_app_ultimate_v6', ...)
        // Wait, script.js used v6 key in save(), but v7 logic in init? 
        // I should verify the key. script.js: save() { localStorage.setItem('sk_app_ultimate_v6', JSON.stringify(this.db)); }
        // So I will use 'sk_app_ultimate_v6'.

        const ACTIVE_DB_KEY = 'sk_app_ultimate_v6';

        function getDB() {
            const raw = localStorage.getItem(ACTIVE_DB_KEY);
            return raw ? JSON.parse(raw) : { customKnowledge: [], ai_logs: [] };
        }

        function saveDB(db) {
            localStorage.setItem(ACTIVE_DB_KEY, JSON.stringify(db));
            render();
            // Trigger local sync feedback
            showToast('Saved to Database');
        }

        function forceSync() {
            // Trigger a storage event for other tabs
            const db = getDB();
            // We re-save to trigger the event. 
            // Also we can toggle a timestamp key.
            db._syncTS = Date.now();
            localStorage.setItem(ACTIVE_DB_KEY, JSON.stringify(db));

            // Also notify logic
            const btn = document.getElementById('broadcast-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check text-green-500"></i> Synced!';
            setTimeout(() => btn.innerHTML = originalText, 2000);
        }

        function showToast(msg) {
            // fast toast implementation
            // console.log(msg);
        }

        function render() {
            const db = getDB();
            const know = db.customKnowledge || [];
            const logs = db.ai_logs || [];

            // 1. Render Knowledge List
            const list = document.getElementById('knowledge-list');
            if (know.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-600 py-10 italic">No training data yet.<br>Add your first rule above!</div>';
            } else {
                list.innerHTML = know.map((k, i) => `
                    <div class="glass-card p-4 rounded-xl group hover:border-purple-500/30 transition flex justify-between items-start">
                        <div>
                            <div class="text-sm font-bold text-purple-300 mb-1">"${k.q}"</div>
                            <div class="text-sm text-slate-400">"${k.a}"</div>
                        </div>
                        <button onclick="deleteItem(${i})" class="text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `).reverse().join(''); // Show newest first
            }

            // 2. Render Logs
            const logContainer = document.getElementById('logs-container');
            if (logs.length === 0) {
                logContainer.innerHTML = '<div class="text-xs text-slate-600 text-center py-4">No failures recorded.</div>';
            } else {
                logContainer.innerHTML = logs.map((l, i) => `
                    <div class="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                        <span class="text-xs text-red-300 truncate max-w-[150px] font-mono">"${l.q}"</span>
                        <button onclick="trainFromLog('${l.q.replace(/'/g, "\\'")}')" class="text-[10px] bg-slate-800 hover:bg-purple-900 text-purple-300 px-2 py-1 rounded border border-slate-700 transition">
                            Train
                        </button>
                    </div>
                `).reverse().join('');
            }

            // 3. Stats
            document.getElementById('stat-total').innerText = know.length;
            document.getElementById('stat-missed').innerText = logs.length;
        }

        function addKnowledge() {
            const q = document.getElementById('new-q').value.trim();
            const a = document.getElementById('new-a').value.trim();
            if (!q || !a) return;

            const db = getDB();
            if (!db.customKnowledge) db.customKnowledge = [];

            // Check usage
            if (db.customKnowledge.some(k => k.q.toLowerCase() === q.toLowerCase())) {
                alert('This trigger already exists!');
                return;
            }

            db.customKnowledge.push({ q, a });
            saveDB(db);

            document.getElementById('new-q').value = '';
            document.getElementById('new-a').value = '';
            forceSync(); // Auto sync on add
        }

        function deleteItem(index) {
            // Because we reversed the render, index is tricky. 
            // Ideally we need unique IDs. For now, let's just find it by value or simple reverse index logic?
            // Actually, map(reverse) is visual. The index passed in map() on original array is correct if we didn't reverse array itself.
            // But I did .reverse().join('').
            // Let's fix render logic to NOT reverse mapping index.

            // Fixed approach:
            const db = getDB();
            const realIndex = (db.customKnowledge.length - 1) - index;

            if (confirm("Delete this rule?")) {
                db.customKnowledge.splice(realIndex, 1);
                saveDB(db);
                forceSync();
            }
        }

        // Simulating the Lev Distance for Test Bench
        function testNeural() {
            const q = document.getElementById('test-q').value;
            if (!q) return;

            // Basic fuzzy match simulation (Levenshtein simple)
            const db = getDB();
            const know = db.customKnowledge || [];

            const result = know.find(k => k.q.toLowerCase().includes(q.toLowerCase()) || q.toLowerCase().includes(k.q.toLowerCase()));

            const resBox = document.getElementById('test-result');
            if (result) {
                resBox.innerHTML = `
                    <div class="text-green-400 font-bold text-xs mb-1 uppercase"><i class="fa-solid fa-check-circle"></i> Match Found</div>
                    <div class="text-white">"${result.a}"</div>
                 `;
            } else {
                resBox.innerHTML = `
                    <div class="text-red-400 font-bold text-xs mb-1 uppercase"><i class="fa-solid fa-circle-xmark"></i> No Match</div>
                    <div class="text-slate-500">I would search Google or ask for clarification.</div>
                 `;
            }
        }

        function trainFromLog(val) {
            document.getElementById('new-q').value = val;
            document.getElementById('new-a').focus();
        }

        function clearLogs() {
            const db = getDB();
            db.ai_logs = [];
            saveDB(db);
        }

        // Init
        render();

        // Listen for syncs from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === ACTIVE_DB_KEY) render();
        });

        // --- IMPORT / EXPORT LOGIC ---
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                if (file.name.endsWith('.json')) {
                    importJSON(content);
                } else if (file.name.endsWith('.csv')) {
                    importCSV(content);
                } else {
                    alert('Unsupported format. Please use .json or .csv');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset
        }

        function importJSON(jsonStr) {
            try {
                const data = JSON.parse(jsonStr);
                const db = getDB();

                // Merge strategies could vary. Here we append new unique ones.
                if (Array.isArray(data)) {
                    // Start of data check
                    let count = 0;
                    data.forEach(item => {
                        if (item.q && item.a) {
                            if (!db.customKnowledge.some(k => k.q.toLowerCase() === item.q.toLowerCase())) {
                                db.customKnowledge.push({ q: item.q, a: item.a });
                                count++;
                            }
                        }
                    });
                    saveDB(db);
                    alert(`Imported ${count} new rules from JSON.`);
                    forceSync();
                } else {
                    alert('Invalid JSON format. Expected an array of objects.');
                }
            } catch (e) {
                console.error(e);
                alert('Error parsing JSON.');
            }
        }

        function importCSV(csvStr) {
            const lines = csvStr.split('\n');
            const db = getDB();
            let count = 0;

            lines.forEach(line => {
                // Simple CSV parse: "Question","Answer" or Question,Answer
                // Taking a simple split approach, but robust CSV regex is better
                // MVP: Split by first comma
                const firstComma = line.indexOf(',');
                if (firstComma > -1) {
                    let q = line.substring(0, firstComma).trim();
                    let a = line.substring(firstComma + 1).trim();

                    // Remove quotes if present
                    if (q.startsWith('"') && q.endsWith('"')) q = q.slice(1, -1);
                    if (a.startsWith('"') && a.endsWith('"')) a = a.slice(1, -1);

                    if (q && a && q.toLowerCase() !== 'question') { // header check
                        if (!db.customKnowledge.some(k => k.q.toLowerCase() === q.toLowerCase())) {
                            db.customKnowledge.push({ q, a });
                            count++;
                        }
                    }
                }
            });

            if (count > 0) {
                saveDB(db);
                alert(`Imported ${count} new rules from CSV.`);
                forceSync();
            } else {
                alert('No valid rules found or all were duplicates.');
            }
        }

        function exportKnowledge() {
            const db = getDB();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db.customKnowledge));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "kitchen_ai_brain_backup.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>

</html>